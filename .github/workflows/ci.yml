name: CI

on:
  push:
  pull_request:

jobs:
  headless-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install package
        run: python -m pip install --upgrade pip && pip install -e .
      - name: Create smoke CSV fixture
        run: python -c "import csv, pathlib; pathlib.Path('.ci').mkdir(exist_ok=True); rows=[('doc','path','value_json'),('geometry','/units','\"mm\"'),('geometry','/prototypes','[]'),('geometry','/instances','[]'),('geometry','/arrays','[]'),('flow','/units','\"mm\"'),('flow','/steps','[]'),('flow','/measurements','[]')]; f=open('.ci/headless_smoke_input.csv','w',newline='',encoding='utf-8'); csv.writer(f).writerows(rows); f.close()"
      - name: Run headless smoke
        run: python -m sov_app --headless .ci/headless_smoke_input.csv --mc-n 20 --out out_headless_ci --no-open3d
      - name: Assert mandatory artifacts
        run: |
          test -f out_headless_ci/mc_results.csv
          test -f out_headless_ci/summary.json
